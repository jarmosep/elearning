var app=angular.module("eLearning",["ui.router","firebase","ngSanitize","ngAnimate"]);app.factory("addWord",function a(){return a.submitWord=function(a,b,c,d,e){e||(e="No example sentences given."),b||(b=null);var f=firebase.auth().currentUser;if(f){var g=firebase.database().ref("users").child(f.uid+"/wordbank"),h=firebase.database().ref("users").child(f.uid+"/tagbank"),i=firebase.database().ref("users").child(f.uid+"/recentActivity"),j=Math.floor(Date.now());g.push({expression:a,reading:b,meaning:c,sentences:e,tags:d,dateAdded:j}),h.push(d),i.push({activity:a+" added to the wordbank",timestamp:j})}else console.log("Erorrs")},a}),app.factory("authFactory",["$state",function a(b){var c=firebase.database().ref("users"),d=firebase.auth();return a.signup=function(a,e,f){var g=d.createUserWithEmailAndPassword(a,e),h=Math.floor(Date.now());return g.then(function(d){c.child(d.uid).set({displayName:f,email:a,status:"student"});var e=firebase.database().ref("users").child(d.uid+"/recentActivity");e.push({activity:"You created a new account!",timestamp:h}),b.go("dashboard.front"),console.log(d)}).catch(function(a){console.log(a)}),g},a.login=function(a,c){var e=d.signInWithEmailAndPassword(a,c);return e.then(function(a){b.go("dashboard.front"),console.log(a)}).catch(function(a){console.log(a)}),e},a.auth=function(){return d},a}]),app.factory("kanjiSearch",["$http",function(a){return{getAllKanjis:function(){var b=a({url:"../api/kanjidict.json",method:"GET",dataType:"jsonp",contentType:"jsonp"});return b.then(function(a){return b.data}),b}}}]);var config={apiKey:"AIzaSyAQCgMuMpoQvh6wlJbVp14t68pOq76y-Kk",authDomain:"elearning-1c775.firebaseapp.com",databaseURL:"https://elearning-1c775.firebaseio.com",storageBucket:"elearning-1c775.appspot.com",messagingSenderId:"595697014369"};firebase.initializeApp(config);var defaultTags=firebase.database().ref("defaultTags"),tags=["adjective-i","adjective-na","adverb","auxiliary","conjunction","common","expression","noun","particle","ichidan-verb","godan-verb","transitive","intransitive","suru-verb","kuru-verb","colloquialism","honorific","onomatopoeic","slang","vulgar","sensitive"];defaultTags.set(tags),app.config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("landing",{url:"/",templateUrl:"templates/landing.html",controller:"LoginCtrl"}).state("dashboard",{url:"/dashboard",abstract:!0,templateUrl:"templates/dashboard.html",controller:"DashboardCtrl",resolve:{currentAuth:["$firebaseAuth",function(a){var b=firebase.auth(),c=a(b);return c.$requireSignIn()}]}}).state("dashboard.front",{url:"",page:"DashboardFront",templateUrl:"templates/mainviews/frontpage.html",controller:"RecentActivityCtrl"}).state("dashboard.wordbank",{templateUrl:"templates/mainviews/wordbank.html",controller:"AllWordsCtrl"}).state("dashboard.word",{url:"/word",templateUrl:"templates/mainviews/singleword.html",controller:"WordDetailsCtrl",params:{obj:null}}).state("dashboard.addword",{templateUrl:"templates/mainviews/addword.html",controller:"WordSubmitCtrl"}).state("dashboard.quiz",{templateUrl:"templates/mainviews/quiz.html",controller:"QuizCtrl"}).state("dashboard.assignments",{templateUrl:"templates/mainviews/assignment.html",controller:"AssignmentsCtrl"}).state("dashboard.askteacher",{templateUrl:"templates/mainviews/ask.html"}),b.otherwise("/")}]),app.run(["$rootScope","$state",function(a,b){a.$on("$stateChangeError",function(a,c,d,e,f,g){"AUTH_REQUIRED"===g&&b.go("/")})}]),app.controller("AllWordsCtrl",["authFactory","$scope","$rootScope","$timeout","$state",function(a,b,c,d,e){function f(a){b.words.push(a)}b.words=[],b.filters=[],b.limit=5,b.showMore=function(){b.limit+=5,d(function(){var a=document.getElementsByTagName("body")[0];a.scrollTop=a.scrollHeight},0,!1)};var g=a.auth(),h=g.currentUser;if(h){var i=firebase.database().ref("defaultTags"),j=firebase.database().ref("users").child(h.uid+"/wordbank"),k=firebase.database().ref("users").child(h.uid+"/tagbank");j.once("value",function(a){var b=a.val();angular.forEach(b,function(a,b){var c={data:a,key:b,visible:!0};d(function(){f(c)})})});var l=[],m=[];k.once("value",function(a){var b=a.val();angular.forEach(b,function(a){l.push(a),m=[].concat.apply([],l)})}),i.once("value",function(a){var c=a.val(),d=c.concat(m);d=d.filter(function(a,b,c){return c.indexOf(a)==b}),console.log(d),b.filters.push(d)})}else console.log("Not logged in.");b.go=function(a){console.log(a),e.go("dashboard.word",{obj:a})},b.removeWord=function(a,d){console.log(b.words.indexOf(d)),c.popkey=null,b.words.splice(b.words.indexOf(d),1);var e=firebase.database().ref("users").child(h.uid+"/wordbank");console.log(e.child(a));var f=e.child(a).remove();f.then(function(){console.log("kaik män")}).catch(function(a){console.log(a)})},c.activeFilters=[],b.toggleFilter=function(a,d){var e=angular.element(a.currentTarget),f=c.activeFilters.indexOf(d);f>=0?(c.activeFilters.splice(f,1),e.removeClass("active"),b.updateWords()):(c.activeFilters.push(d),e.addClass("active"),b.updateWords())},b.updateWords=function(){for(var a,d=b.words,e=c.activeFilters.sort(),f=0,g=d.length;f<g;f++){a=d[f].data.tags.sort();var h=e.every(function(b){return a.indexOf(b)>=0});d[f].visible=h}}}]),app.controller("AssignmentsCtrl",["$scope",function(a){a.assignments=[{title:"Basic Japanese - Quiz 4/8",description:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Necessitatibus ad soluta perspiciatis totam incidunt officiis doloribus!",due:"29.11.2016 18:30",completed:!1,grade:""},{title:"Basic Japanese - Quiz 3/8",description:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Necessitatibus ad soluta perspiciatis totam incidunt officiis doloribus!",due:"22.11.2016 18:30",completed:!0,grade:"A"},{title:"Basic Japanese - Quiz 2/8",description:"Necessitatibus ad soluta perspiciatis totam incidunt officiis doloribus! Lorem ipsum dolor sit amet, consectetur adipisicing elit. ",due:"15.11.2016 18:30",completed:!0,grade:"S"},{title:"Basic Japanese - Quiz 1/8",description:"Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.",due:"15.11.2016 18:30",completed:!0,grade:"S"},{title:"Listening comprehension 1/2",description:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Necessitatibus ad soluta perspiciatis totam incidunt officiis doloribus!",due:"7.11.2016 18:30",completed:!0,grade:"C"}]}]),app.controller("DashboardCtrl",["$scope","$state","$timeout","authFactory",function(a,b,c,d){a.state=b,a.obj={},console.log(firebase),firebase.auth().onAuthStateChanged(function(b){if(b){var d=firebase.database().ref("users").child(b.uid);d.on("value",function(b){c(function(){a.obj={displayName:b.val().displayName}},0)})}else console.log("Not logged in.")}),a.logout=function(){var a=firebase.auth().signOut();a.then(function(){b.go("landing")})}}]),app.controller("LoginCtrl",["authFactory","$scope",function(a,b){b.signup=function(b,c,d){a.signup(b,c,d)},b.login=function(b,c){a.login(b,c)}}]),app.controller("RecentActivityCtrl",["authFactory","$rootScope","$scope","$timeout",function(a,b,c,d){function e(a){c.recents.push(a)}c.recents=[];var f=a.auth(),g=f.currentUser;if(console.log(g),g){var h=firebase.database().ref("users").child(g.uid+"/recentActivity");h.once("value",function(a){var b=a.val();angular.forEach(b,function(a,b){var c={data:a,key:b};d(function(){e(c)})})})}else console.log("Not logged in.");c.removeActivity=function(a,d){b.popkey=null,console.log(d),c.recents.splice(c.recents.indexOf(d),1);var e=firebase.database().ref("users").child(g.uid+"/recentActivity");console.log(e.child(a));var f=e.child(a).remove();f.then(function(){console.log("kaik män")}).catch(function(a){console.log(a)})}}]),app.controller("WordDetailsCtrl",["$scope","$state","$stateParams","kanjiSearch",function(a,b,c,d){a.word=c.obj,console.log(a.word.data.expression);var e=a.word.data.expression.split("");a.kanjis=[],a.results=[];for(var f=0;f<e.length;f++)e[f].match(/^[\u4e00-\u9faf]+$/)&&a.kanjis.push(e[f]);a.searchCharacter=function(b){var c=d.getAllKanjis();c.then(function(c){if(a.kanjis.length>=1)for(var d=0;d<a.kanjis.length;d++){var e=c.data.filter(function(a){return a.literal[0]==b[d]});if(e){var f=[];f=e[0],console.log(f),a.results.push(f)}}})},a.chinese=function(a){return"ja_on"==a.$.r_type},a.japanese=function(a){return"ja_kun"==a.$.r_type},0==!a.kanjis.length?a.searchCharacter(a.kanjis):console.log("No kanjis here.")}]),app.controller("WordSubmitCtrl",["$scope","addWord",function(a,b){a.form={},a.onSubmit=function(c,d,e,f,g){b.submitWord(c,d,e,f,g),a.form=null},a.clearFields=function(){a.form=null}}]),app.directive("activity",function(){return{restrict:"E",scope:{recent:"="},templateUrl:"templates/mainviews/partials/frontpage-activity.html"}}),app.directive("assignment",function(){return{restrict:"E",replace:!0,scope:{data:"="},templateUrl:"templates/mainviews/partials/assignment-test.html"}}),app.directive("outsideClick",["$document","$parse",function(a,b){return{restrict:"A",link:function(b,c,d,e){c.bind("click",function(a){a.stopPropagation()}),a.bind("click",function(){b.$apply(d.outsideClick)})}}}]),app.directive("word",function(){return{restrict:"E",scope:{word:"="},templateUrl:"templates/mainviews/partials/wordbank-wordblock.html"}});