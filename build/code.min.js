var app=angular.module("eLearning",["ui.router","ui.select","firebase","ngSanitize","ngAnimate"]);app.factory("addWord",function a(){return a.submitWord=function(a,b,c){var d=firebase.auth().currentUser;if(d){var e=firebase.database().ref("wordbank"),f=firebase.database().ref("tagbank"),g=firebase.database().ref("recentActivities");e.push(a),g.push(b);var h=[];f.once("value",function(a){var b=a.val();angular.forEach(b,function(a){h.push(a)})});var i=h.concat(c);i=i.filter(function(a,b,c){return c.indexOf(a)==b}),f.set(i)}else console.log("Errors")},a}),app.factory("authFactory",["$state",function a(b){var c,d=firebase.database().ref("users"),e=firebase.database().ref("recentActivities"),f=firebase.database().ref("tagbank"),g=firebase.auth();return a.signup=function(a,c,h,i){console.log(i);var j=g.createUserWithEmailAndPassword(a,c),k=Math.floor(Date.now());return j.then(function(c){d.child(c.uid).set({displayName:h,email:a,status:i}),e.child(c.uid),e.push({activity:h+" just registered",timestamp:k,addedBy:h});var g=["adjective-i","adjective-na","adverb","auxiliary","conjunction","common","expression","noun","particle","ichidan-verb","godan-verb","transitive","intransitive","suru-verb","kuru-verb","colloquialism","honorific","onomatopoeic","slang","vulgar","sensitive"];f.set(g),"student"===i?b.go("dashboard.front"):"teacher"===i?b.go("dashboard.admin"):console.log("Can't go."),console.log(c)}).catch(function(a){console.log(a)}),j},a.login=function(a,d){var e=g.signInWithEmailAndPassword(a,d);return e.then(function(a){if(a){var d=firebase.database().ref("users").child(a.uid);d.once("value",function(a){var d=a.val();c=d.status,console.log(c),"student"===c?b.go("dashboard.front"):"teacher"===c?b.go("dashboard.admin"):console.log("Got nowhere to go.")})}console.log(a)}).catch(function(a){console.log(a)}),e},a.auth=function(){return g},a}]),app.factory("createDeck",function a(){return a.submitDeck=function(a){var b=firebase.auth().currentUser;if(b){var c=firebase.database().ref("assignmentsStudent");c.push(a)}else console.log("Erorrs")},a}),app.factory("ForvoPronunciation",["$http",function(a){return{getSoundfile:function(b,c){var d=a({url:"http://apifree.forvo.com/key/"+b+"/format/json/action/standard-pronunciation/word/"+c+"/language/ja",method:"GET",cache:"true",type:"json",contentType:"json"});return d.then(function(a){return console.log(a.data),d.data}),d}}}]),app.factory("kanjiSearch",["$http",function(a){return{getAllKanjis:function(){var b=a({url:"../api/kanjidict.json",method:"GET",dataType:"jsonp",contentType:"jsonp"});return b.then(function(a){return b.data}),b}}}]);var config={apiKey:"AIzaSyAQCgMuMpoQvh6wlJbVp14t68pOq76y-Kk",authDomain:"elearning-1c775.firebaseapp.com",databaseURL:"https://elearning-1c775.firebaseio.com",storageBucket:"elearning-1c775.appspot.com",messagingSenderId:"595697014369"};firebase.initializeApp(config),app.config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("landing",{url:"/",templateUrl:"templates/landing.html",controller:"LoginCtrl"}).state("dashboard",{url:"/dashboard",abstract:!0,templateUrl:"templates/dashboard.html",controller:"DashboardCtrl",resolve:{currentAuth:["$firebaseAuth",function(a){var b=firebase.auth(),c=a(b);return c.$requireSignIn()}]}}).state("dashboard.front",{url:"",page:"DashboardFront",templateUrl:"templates/mainviews/frontpage.html",controller:"RecentActivityCtrl"}).state("dashboard.wordbank",{url:"/wordbank",templateUrl:"templates/mainviews/wordbank.html",controller:"AllWordsCtrl"}).state("dashboard.word",{url:"/wordbank/word/:word",templateUrl:"templates/mainviews/singleword.html",controller:"WordDetailsCtrl",params:{obj:null}}).state("dashboard.addword",{url:"/addword",templateUrl:"templates/mainviews/addword.html",controller:"WordSubmitCtrl"}).state("dashboard.quiz-memorize",{url:"/memorize/:assignment",templateUrl:"templates/mainviews/quiz-memorize.html",controller:"MemorizeCtrl"}).state("dashboard.quiz-type",{url:"/type/:assignment",templateUrl:"templates/mainviews/quiz-type.html",controller:"TypeCtrl"}).state("dashboard.quiz-listen",{url:"/listen/:assignment",templateUrl:"templates/mainviews/quiz-listen.html",controller:"ListenCtrl"}).state("dashboard.assignments",{url:"/assignment",templateUrl:"templates/mainviews/assignment.html",controller:"AssignmentsCtrl",params:{obj:null}}).state("dashboard.askteacher",{url:"/ask",templateUrl:"templates/mainviews/ask.html",controller:"AskQuestionCtrl"}).state("dashboard.admin",{url:"/admin",page:"DashboardAdmin",templateUrl:"templates/mainviews/teacher-frontpage.html",controller:"RecentActivityCtrl"}).state("dashboard.quizmaker",{url:"/admin/quizmaker",templateUrl:"templates/mainviews/quizmaker.html",controller:"CreateTeacherQuizCtrl"}).state("dashboard.quizzes",{url:"/admin/quizzes",templateUrl:"templates/mainviews/teacher-quizzes.html",controller:"TeacherQuizzesCtrl"}).state("dashboard.answer",{url:"/admin/answer",templateUrl:"templates/mainviews/teacher-answer.html",controller:"AskQuestionCtrl"}),b.otherwise("/")}]),app.run(["$rootScope","$state",function(a,b){a.$on("$stateChangeError",function(a,c,d,e,f,g){"AUTH_REQUIRED"===g&&b.go("/")})}]),app.controller("AllWordsCtrl",["authFactory","createDeck","$scope","$rootScope","$timeout","$state",function(a,b,c,d,e,f){function g(a){c.words.push(a)}c.words=[],c.filters=[],c.limit=5,c.loading=!0,c.collection=[],c.currentUser,c.showMore=function(){c.limit+=5,e(function(){var a=document.getElementsByTagName("body")[0];a.scrollTop=a.scrollHeight},0,!1)};var h=a.auth(),i=h.currentUser;if(i){var j=firebase.database().ref("wordbank"),k=firebase.database().ref("tagbank");j.once("value",function(a){var b=a.val();angular.forEach(b,function(a,b){var d={data:a,key:b,visible:!0};e(function(){g(d),c.loading=!1})})}),k.once("value",function(a){var b=a.val();console.log(b),c.filters.push(b)});var l=firebase.database().ref("users").child(i.uid);l.once("value",function(a){var a=a.val();c.currentUser=a.displayName})}else console.log("Not logged in.");c.tab=0,c.setTab=function(a){c.tab=a},c.isSet=function(a){return c.tab===a},c.removeWord=function(a,b){console.log(c.words.indexOf(b)),c.words.splice(c.words.indexOf(b),1);var d=firebase.database().ref("wordbank").child(a);console.log(d.child(a));var e=d.remove();e.then(function(){console.log("they gone")}).catch(function(a){console.log(a)})},c.newDeck=function(){var a=(firebase.database().ref("assignmentsStudent"),Math.floor(Date.now())),d={deckName:c.deckName,description:c.description,words:c.collection,cardLength:c.collection.length,createdBy:c.currentUser,date:a};b.submitDeck(d),c.deckName=null,c.description=null,c.collection.length=0},d.activeFilters=[],c.toggleFilter=function(a,b){var e=angular.element(a.currentTarget),f=d.activeFilters.indexOf(b);f>=0?(d.activeFilters.splice(f,1),e.removeClass("active"),c.updateWords()):(d.activeFilters.push(b),e.addClass("active"),c.updateWords())},c.updateWords=function(){for(var a,b=c.words,e=d.activeFilters.sort(),f=0,g=b.length;f<g;f++){a=b[f].data.tags.sort();var h=e.every(function(b){return a.indexOf(b)>=0});b[f].visible=h}}}]),app.controller("AnswerQuestionsCtrl",["authFactory","$scope",function(a,b){b.tab=1,b.setTab=function(a){b.tab=a},b.isSet=function(a){return b.tab===a}}]),app.controller("AskQuestionCtrl",["authFactory","$scope",function(a,b){b.form={},b.showQuestions="",b.currentUser,b.tab=1,b.setTab=function(a){b.tab=a},b.isSet=function(a){return b.tab===a};var c,d,e=firebase.auth().currentUser;e?(c=firebase.database().ref("users").child(e.uid),d=firebase.database().ref("studentQuestions"),c.once("value",function(a){var a=a.val();console.log(a),b.currentUser=a.displayName}),d.on("value",function(a){var a=a.val();b.showQuestions=a,console.log(b.showQuestions)})):console.log("Not logged in.");var f=Math.floor(Date.now());b.onSubmit=function(){var a={type:b.form.questionType,question:b.form.questionText,askedBy:b.currentUser,date:f,answer:0};d.push(a),b.form.questionType=null,b.form.questionText=null},b.answerTheQuestion=function(a,b,c){b.answer=c,console.log(a);var b=b.answer;d.child(a).update({answer:b})}}]),app.controller("AssignmentsCtrl",["$scope","$timeout","authFactory","$state",function(a,b,c,d,e){a.assignments=[];var f=firebase.auth().currentUser;if(a.loading=!0,a.currentUser,a.currentUser=function(){return b.ActiveUser},a.modalShown=!1,a.toggleModal=function(b){a.modal={deckName:b},b?a.modalShown=!0:a.modalShown=!1},a.tab=1,a.setTab=function(b){a.tab=b},a.isSet=function(b){return a.tab===b},f){var g=firebase.database().ref("users").child(f.uid);g.once("value",function(b){var b=b.val();a.currentUser=b.displayName,console.log(a.currentUser)});var h=firebase.database().ref("assignmentsStudent");h.once("value",function(b){var c=b.val();angular.forEach(c,function(b,c){var d={cardData:b,key:c,visible:!0};a.assignments.push(d),console.log(a.assignments),a.loading=!1})})}else console.log("Not logged in.");a.go=function(a){console.log(a),e.go("dashboard.quiz",{obj:h.cardData.words})},a.removeAssignment=function(b,c){console.log(a.assignments.indexOf(c)),a.assignments.splice(a.assignments.indexOf(c),1);var d=firebase.database().ref("assignmentsStudent").child(b),e=d.remove();console.log(d.child(b)),e.then(function(){console.log("bye")}).catch(function(a){console.log(a)})}}]),app.controller("CreateTeacherQuizCtrl",["authFactory","$scope",function(a,b){b.quizzes=[],b.addQuiz=function(a){b.quizzes.push(a)}}]),app.controller("DashboardCtrl",["$scope","$state","$timeout","$window","authFactory",function(a,b,c,d,e){a.state=b,a.navbar="",a.obj={},firebase.auth().onAuthStateChanged(function(b){if(b){var f=firebase.database().ref("users").child(b.uid);d.user=e.auth().currentUser,f.on("value",function(b){c(function(){a.obj={displayName:b.val().displayName};var c=b.val().status;"student"===c?a.navbar=g:"teacher"===c?a.navbar=h:a.navbar=i},0)});var g=[{stateName:"dashboard.front",icon:"ion-home",description:"Dashboard"},{stateName:"dashboard.addword",icon:"ion-plus-circled",description:"Add words"},{stateName:"dashboard.wordbank",icon:"ion-filing",description:"Wordbank"},{stateName:"dashboard.assignments",icon:"ion-university",description:"Assignments"},{stateName:"dashboard.askteacher",icon:"ion-chatboxes",description:"Ask teacher"}],h=[{stateName:"dashboard.admin",icon:"ion-home",description:"Dashboard"},{stateName:"dashboard.addword",icon:"ion-plus-circled",description:"Add words"},{stateName:"dashboard.wordbank",icon:"ion-filing",description:"Wordbank"},{stateName:"dashboard.quizmaker",icon:"ion-document-text",description:"Create quiz"},{stateName:"dashboard.quizzes",icon:"ion-university",description:"Quizzes"},{stateName:"dashboard.answer",icon:"ion-chatboxes",description:"Answer questions"}],i="Error"}else console.log("Not logged in.")}),a.logout=function(){var a=firebase.auth().signOut();a.then(function(){b.go("landing")})}}]),app.controller("ListenCtrl",["$scope","$state","$stateParams","$timeout","ForvoPronunciation",function(a,b,c,d,e){var f=c.assignment;f||b.go("dashboard.assignment");var g,h,i,j,k,l,m=(firebase.auth().currentUser,decodeURIComponent(f)),n=firebase.database().ref("assignmentsStudent");firebase.database().ref("apikey").once("value",function(a){k=a.val()}),n.orderByChild("deckName").equalTo(m).once("value",function(b){var c=b.val();a.assignment=c[Object.keys(c)],g=a.assignment.words.length,h=1/g*100;for(var d,f,m=a.assignment.words.length;0!==m;)f=Math.floor(Math.random()*m),m-=1,d=a.assignment.words[m],a.assignment.words[m]=a.assignment.words[f],a.assignment.words[f]=d;l=a.assignment.words[0].expression,j=e.getSoundfile(k,l),console.log(l),j.then(function(a){i=new Audio(a.data.items[0].pathmp3)})});a.getWord=function(a){j=e.getSoundfile(k,a),j.then(function(a){i=new Audio(a.data.items[0].pathmp3)})},a.playAudio=function(){i.play()},a.index=0,a.answer={opacity:0},a.counter=0,a.hide=!1,a.progressPercentage=0,a.listeningWrong=!1,a.listeningRight=!1,a.listening=!1,a.showText={opacity:1},a.setClass="",a.showText="",a.showCorrectExpression=function(b,c){a.setClass="shrink",a.showText="showText",b==c?(a.showUserAnswer=b,a.listeningRight=!0,a.listening=!0,a.answer={opacity:1}):(a.showUserAnswer=b,a.listeningWrong=!0,a.listening=!0,a.answer={opacity:1})},a.nextWord=function(b,c){0===b&&(a.counter+=0),1===b&&(a.counter+=1),a.setClass="",a.listeningRight=!1,a.listeningWrong=!1,a.listening=!1,a.showText="",a.progressPercentage+=h,a.index=a.index+1,a.answer={opacity:0,transition:"none"},a.index>=g&&(a.hide=!0,console.log("You got "+a.counter+" out of "+g+" right!"))}}]),app.controller("LoginCtrl",["authFactory","$scope",function(a,b){b.signup=function(b,c,d,e){a.signup(b,c,d,e)},b.login=function(b,c){a.login(b,c)},b.tab=1,b.setTab=function(a){b.tab=a},b.isSet=function(a){return b.tab===a}}]),app.controller("MemorizeCtrl",["$scope","$state","$stateParams","$timeout",function(a,b,c,d){var e=c.assignment;e||b.go("dashboard.assignment");var f,g,h=(firebase.auth().currentUser,decodeURIComponent(e)),i=firebase.database().ref("assignmentsStudent");i.orderByChild("deckName").equalTo(h).once("value",function(b){var c=b.val();a.assignment=c[Object.keys(c)],f=a.assignment.words.length,g=1/f*100;for(var d,e,h=a.assignment.words.length;0!==h;)e=Math.floor(Math.random()*h),h-=1,d=a.assignment.words[h],a.assignment.words[h]=a.assignment.words[e],a.assignment.words[e]=d;console.log(a.assignment)});a.index=0,a.answerChoices=!1,a.answer={opacity:0},a.showText="Show answer",a.quizOver=!1,a.counter=0,a.hide=!1,a.progressPercentage=0,a.showAnswer=function(){a.answer={opacity:1},a.showText="Do you remember this word?",a.answerChoices=!0},a.nextWord=function(b){0===b&&(a.counter+=0),1===b&&(a.counter+=1),a.progressPercentage+=g,a.index=a.index+1,a.showText="Show answer",a.answerChoices=!1,a.answer={opacity:0},a.index>=f&&(a.quizOver=!0,a.hide=!0,console.log("You got "+a.counter+" out of "+f+" right!"))}}]),app.controller("RecentActivityCtrl",["authFactory","$rootScope","$scope","$timeout",function(a,b,c,d){function e(a){c.recents.push(a)}c.recents=[];var f=(a.auth(),firebase.auth().currentUser);if(console.log(f),f){var g=firebase.database().ref("recentActivities");g.once("value",function(a){var b=a.val();angular.forEach(b,function(a,b){var c={data:a,key:b};d(function(){e(c)})})})}else console.log("Not logged in.");c.removeActivity=function(a,d){b.popkey=null,console.log(d),c.recents.splice(c.recents.indexOf(d),1);var e=firebase.database().ref("recentActivities").child(a);console.log(e.child(a));var f=e.remove();f.then(function(){console.log("be gone")}).catch(function(a){console.log(a)})}}]),app.controller("TypeCtrl",["$scope","$state","$stateParams","$timeout","ForvoPronunciation",function(a,b,c,d,e){var f=c.assignment;f||b.go("dashboard.assignment");var g,h,i=(firebase.auth().currentUser,decodeURIComponent(f)),j=firebase.database().ref("assignmentsStudent");j.orderByChild("deckName").equalTo(i).once("value",function(b){var c=b.val();a.assignment=c[Object.keys(c)],g=a.assignment.words.length,h=1/g*100;for(var d,e,f=a.assignment.words.length;0!==f;)e=Math.floor(Math.random()*f),f-=1,d=a.assignment.words[f],a.assignment.words[f]=a.assignment.words[e],a.assignment.words[e]=d});a.index=0,a.answer={opacity:0},a.quizOver=!1,a.counter=0,a.hide=!1,a.progressPercentage=0,a.listeningWrong=!1,a.listeningRight=!1,a.listening=!1,a.showCorrectExpression=function(b,c){b==c?(a.showUserAnswer=b,a.listeningRight=!0,a.listening=!0,a.answer={opacity:1}):(a.showUserAnswer=b,a.listeningWrong=!0,a.listening=!0,a.answer={opacity:1})},a.nextWord=function(b,c){0===b&&(a.counter+=0),1===b&&(a.counter+=1),a.listeningRight=!1,a.listeningWrong=!1,a.listening=!1,a.progressPercentage+=h,a.index=a.index+1,a.answer={opacity:0},a.index>=g&&(a.quizOver=!0,a.hide=!0,console.log("You got "+a.counter+" out of "+g+" right!"))}}]),app.controller("WordDetailsCtrl",["$scope","$http","$state","$stateParams","$timeout","kanjiSearch","authFactory","ForvoPronunciation",function(a,b,c,d,e,f,g,h){var i=d.word;i||c.go("dashboard.wordbank");var j,k=(firebase.auth().currentUser,decodeURIComponent(i)),l=firebase.database().ref("wordbank");a.loading=!0;firebase.database().ref("apikey").once("value",function(a){j=a.val()}),l.orderByChild("meaning").equalTo(k).once("value",function(b){var c=b.val();a.word=c[Object.keys(c)];var d=a.word.expression.split("");a.kanjis=[],a.results=[];for(var g=0;g<d.length;g++)d[g].match(/^[\u4e00-\u9faf]+$/)&&a.kanjis.push(d[g]);var i,k=h.getSoundfile(j,a.word.expression);k.then(function(a){i=new Audio(a.data.items[0].pathmp3)}),a.playAudio=function(){i.play()},a.searchCharacter=function(b){var c=f.getAllKanjis();c.then(function(c){if(a.kanjis.length>=1)for(var d=0;d<a.kanjis.length;d++){var e=c.data.filter(function(a){return a.literal[0]==b[d]});if(e){var f=[];f=e[0],console.log(f),a.results.push(f)}}})},a.chinese=function(a){return"ja_on"==a.$.r_type},a.japanese=function(a){return"ja_kun"==a.$.r_type},0==!a.kanjis.length?a.searchCharacter(a.kanjis):console.log("No kanjis here."),e(function(){a.loading=!1},0)})}]),app.controller("WordSubmitCtrl",["$scope","addWord","$timeout",function(a,b,c){a.form={},a.tags=[],a.currentUser;var d=firebase.auth().currentUser;if(firebase.auth().onAuthStateChanged(function(b){if(b){var c=firebase.database().ref("users").child(b.uid);c.once("value",function(b){var b=b.val();console.log(b),a.currentUser=b.displayName})}else console.log("Not logged in.")}),a.onSubmit=function(){a.form.sentences||(a.form.sentences="No example sentences given."),a.form.reading||(a.form.reading="");var c={expression:a.form.expression,reading:a.form.reading,meaning:a.form.meaning,tags:a.form.selectedItem,sentences:a.form.sentences,createdBy:a.currentUser},d=Math.floor(Date.now()),e={activity:a.currentUser+" added "+a.form.expression+" to the wordbank",timestamp:d,addedBy:a.currentUser},f=a.form.selectedItem;console.log(f),b.submitWord(c,e,f),a.form=null},a.clearFields=function(){a.form=null},d){var e=firebase.database().ref("tagbank");e.on("value",function(b){a.tags=b.val(),console.log(a.tags)}),a.selectedItem=a.tags[0]}else console.log("not logged in")}]),app.directive("activity",function(){return{restrict:"E",scope:{recent:"="},templateUrl:"templates/mainviews/partials/frontpage-activity.html"}}),app.directive("addToDeck",function(){return{link:function(a,b){a.$watch("deckEnable",function(){b.on("click",function(b){function c(a,b){var c=a.indexOf(b);c===-1?(a.push(b),console.log(a)):(a.splice(c,1),console.log(a))}a.isSet(2)&&(b.preventDefault(),b.stopImmediatePropagation(),b.stopPropagation(),c(a.collection,a.word.data),a.$apply(function(){a.selectedWord=!a.selectedWord}))}),a.isSet(2)||(a.selectedWord=!1,a.collection.length=0)})}}}),app.directive("assignment",function(){return{restrict:"E",replace:!0,scope:{data:"="},controller:"AssignmentsCtrl",templateUrl:"templates/mainviews/partials/assignment-test.html"}}),app.directive("outsideClick",["$document","$parse",function(a,b){return{restrict:"A",link:function(b,c,d,e){c.bind("click",function(a){a.stopPropagation()}),a.bind("click",function(){b.$apply(d.outsideClick)})}}}]),app.directive("word",function(){return{restrict:"E",scope:{word:"="},templateUrl:"templates/mainviews/partials/wordbank-wordblock.html"}});