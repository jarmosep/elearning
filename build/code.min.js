var app=angular.module("eLearning",["ui.router","ui.select","firebase","ngSanitize","ngAnimate"]);app.factory("addWord",function a(){return a.submitWord=function(a,b,c){var d=firebase.auth().currentUser;if(d){var e=firebase.database().ref("users").child(d.uid+"/wordbank"),f=firebase.database().ref("users").child(d.uid+"/tagbank"),g=firebase.database().ref("users").child(d.uid+"/recentActivity");e.push(a),g.push(b);var h=[];f.once("value",function(a){var b=a.val();angular.forEach(b,function(a){h.push(a)})});var i=h.concat(c);i=i.filter(function(a,b,c){return c.indexOf(a)==b}),f.set(i)}else console.log("Erorrs")},a}),app.factory("authFactory",["$state",function a(b){var c=firebase.database().ref("users"),d=firebase.auth();return a.signup=function(a,e,f){var g=d.createUserWithEmailAndPassword(a,e),h=Math.floor(Date.now());return g.then(function(d){c.child(d.uid).set({displayName:f,email:a,status:"student"});var e=firebase.database().ref("users").child(d.uid+"/recentActivity");e.push({activity:"You created a new account!",timestamp:h});var g=firebase.database().ref("users").child(d.uid+"/tagbank"),i=["adjective-i","adjective-na","adverb","auxiliary","conjunction","common","expression","noun","particle","ichidan-verb","godan-verb","transitive","intransitive","suru-verb","kuru-verb","colloquialism","honorific","onomatopoeic","slang","vulgar","sensitive"];g.set(i),b.go("dashboard.front"),console.log(d)}).catch(function(a){console.log(a)}),g},a.login=function(a,c){var e=d.signInWithEmailAndPassword(a,c);return e.then(function(a){b.go("dashboard.front"),console.log(a)}).catch(function(a){console.log(a)}),e},a.auth=function(){return d},a}]),app.factory("createDeck",function a(){return a.submitDeck=function(a){var b=firebase.auth().currentUser;if(b){var c=firebase.database().ref("users").child(b.uid+"/assignments");c.push(a)}else console.log("Erorrs")},a}),app.factory("getUserInfo",function a(){var b=firebase.auth().currentUser;return a.getUidForWords=function(){if(b){var a=firebase.database().ref("users").child(b.uid+"/wordbank");return a}return!1},a.getUidForAssignments=function(){if(b){var a=firebase.database().ref("users").child(b.uid+"/assignments");return a}return!1},a}),app.factory("kanjiSearch",["$http",function(a){return{getAllKanjis:function(){var b=a({url:"../api/kanjidict.json",method:"GET",dataType:"jsonp",contentType:"jsonp"});return b.then(function(a){return b.data}),b}}}]);var config={apiKey:"AIzaSyAQCgMuMpoQvh6wlJbVp14t68pOq76y-Kk",authDomain:"elearning-1c775.firebaseapp.com",databaseURL:"https://elearning-1c775.firebaseio.com",storageBucket:"elearning-1c775.appspot.com",messagingSenderId:"595697014369"};firebase.initializeApp(config),app.config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("landing",{url:"/",templateUrl:"templates/landing.html",controller:"LoginCtrl"}).state("dashboard",{url:"/dashboard",abstract:!0,templateUrl:"templates/dashboard.html",controller:"DashboardCtrl",resolve:{currentAuth:["$firebaseAuth",function(a){var b=firebase.auth(),c=a(b);return c.$requireSignIn()}]}}).state("dashboard.front",{url:"",page:"DashboardFront",templateUrl:"templates/mainviews/frontpage.html",controller:"RecentActivityCtrl"}).state("dashboard.wordbank",{url:"/wordbank",templateUrl:"templates/mainviews/wordbank.html",controller:"AllWordsCtrl"}).state("dashboard.word",{url:"/wordbank/word/:word",templateUrl:"templates/mainviews/singleword.html",controller:"WordDetailsCtrl",params:{obj:null}}).state("dashboard.addword",{url:"/addword",templateUrl:"templates/mainviews/addword.html",controller:"WordSubmitCtrl"}).state("dashboard.quiz",{url:"/quiz/:assignment",templateUrl:"templates/mainviews/quiz.html",controller:"QuizCtrl"}).state("dashboard.assignments",{url:"/assignment",templateUrl:"templates/mainviews/assignment.html",controller:"AssignmentsCtrl",params:{obj:null}}).state("dashboard.askteacher",{url:"/ask",templateUrl:"templates/mainviews/ask.html"}),b.otherwise("/")}]),app.run(["$rootScope","$state",function(a,b){a.$on("$stateChangeError",function(a,c,d,e,f,g){"AUTH_REQUIRED"===g&&b.go("/")})}]),app.controller("AllWordsCtrl",["authFactory","createDeck","$scope","$rootScope","$timeout","$state",function(a,b,c,d,e,f){function g(a){c.words.push(a)}c.words=[],c.filters=[],c.limit=5,c.loading=!0,c.collection=[],c.showMore=function(){c.limit+=5,e(function(){var a=document.getElementsByTagName("body")[0];a.scrollTop=a.scrollHeight},0,!1)};var h=a.auth(),i=h.currentUser;if(i){var j=firebase.database().ref("users").child(i.uid+"/wordbank"),k=firebase.database().ref("users").child(i.uid+"/tagbank");j.once("value",function(a){var b=a.val();angular.forEach(b,function(a,b){var d={data:a,key:b,visible:!0};e(function(){g(d),c.loading=!1})})}),k.once("value",function(a){var b=a.val();console.log(b),c.filters.push(b)})}else console.log("Not logged in.");c.removeWord=function(a,b){console.log(c.words.indexOf(b)),c.words.splice(c.words.indexOf(b),1);var d=firebase.database().ref("users").child(i.uid+"/wordbank");console.log(d.child(a));var e=d.child(a).remove();e.then(function(){console.log("kaik män")}).catch(function(a){console.log(a)})},c.newDeck=function(){var a=(firebase.database().ref("users").child(i.uid),Math.floor(Date.now())),d={deckName:c.deckName,description:c.description,words:c.collection,cardLength:c.collection.length,date:a};b.submitDeck(d),c.deckName=null,c.description=null,c.collection.length=0},d.activeFilters=[],c.toggleFilter=function(a,b){var e=angular.element(a.currentTarget),f=d.activeFilters.indexOf(b);f>=0?(d.activeFilters.splice(f,1),e.removeClass("active"),c.updateWords()):(d.activeFilters.push(b),e.addClass("active"),c.updateWords())},c.updateWords=function(){for(var a,b=c.words,e=d.activeFilters.sort(),f=0,g=b.length;f<g;f++){a=b[f].data.tags.sort();var h=e.every(function(b){return a.indexOf(b)>=0});b[f].visible=h}}}]),app.controller("AssignmentsCtrl",["$scope","$timeout","authFactory","$state",function(a,b,c,d){function e(b){a.assignments.push(b),console.log(a.assignments)}a.assignments=[];var f=c.auth(),g=f.currentUser;if(a.loading=!0,g){var h=firebase.database().ref("users").child(g.uid+"/assignments");h.once("value",function(c){var d=c.val();angular.forEach(d,function(c,d){var f={cardData:c,key:d,visible:!0};b(function(){e(f),a.loading=!1})})})}else console.log("Not logged in.");a.go=function(a){console.log(a),d.go("dashboard.quiz",{obj:h.cardData.words})},a.removeAssignment=function(b,c){console.log(a.assignments.indexOf(c)),a.assignments.splice(a.assignments.indexOf(c),1);var d=firebase.database().ref("users").child(g.uid+"/assignments"),e=d.child(b).remove();console.log(d.child(b)),e.then(function(){console.log("kaik män")}).catch(function(a){console.log(a)})}}]),app.controller("DashboardCtrl",["$scope","$state","$timeout","$window","authFactory",function(a,b,c,d,e){a.state=b,a.obj={},console.log(firebase),firebase.auth().onAuthStateChanged(function(b){if(b){var f=firebase.database().ref("users").child(b.uid);d.user=e.auth().currentUser,f.on("value",function(b){c(function(){a.obj={displayName:b.val().displayName}},0)})}else console.log("Not logged in.")}),a.logout=function(){var a=firebase.auth().signOut();a.then(function(){b.go("landing")})}}]),app.controller("LoginCtrl",["authFactory","$scope",function(a,b){b.signup=function(b,c,d){a.signup(b,c,d)},b.login=function(b,c){a.login(b,c)}}]),app.controller("QuizCtrl",["$scope","$state","$stateParams","$timeout","getUserInfo",function(a,b,c,d,e){var f=c.assignment;f||b.go("dashboard.assignment"),a.hide=!1;var g=decodeURIComponent(f),h=e.getUidForAssignments();h.orderByChild("deckName").equalTo(g).once("value",function(b){var c=b.val();a.assignment=c[Object.keys(c)],console.log(a.assignment)});a.answerChoices=!1,a.answer={opacity:0},a.showText="Show answer",a.showAnswer=function(){a.answer={opacity:1},a.showText="Do you remember this word?",a.answerChoices=!0}}]),app.controller("RecentActivityCtrl",["authFactory","$rootScope","$scope","$timeout",function(a,b,c,d){function e(a){c.recents.push(a)}c.recents=[];var f=a.auth(),g=f.currentUser;if(console.log(g),g){var h=firebase.database().ref("users").child(g.uid+"/recentActivity");h.once("value",function(a){var b=a.val();angular.forEach(b,function(a,b){var c={data:a,key:b};d(function(){e(c)})})})}else console.log("Not logged in.");c.removeActivity=function(a,d){b.popkey=null,console.log(d),c.recents.splice(c.recents.indexOf(d),1);var e=firebase.database().ref("users").child(g.uid+"/recentActivity");console.log(e.child(a));var f=e.child(a).remove();f.then(function(){console.log("kaik män")}).catch(function(a){console.log(a)})}}]),app.controller("WordDetailsCtrl",["$scope","$state","$stateParams","$timeout","kanjiSearch","getUserInfo",function(a,b,c,d,e,f){var g=c.word;g||b.go("dashboard.wordbank");var h=decodeURIComponent(g),i=f.getUidForWords();a.loading=!0;i.orderByChild("meaning").equalTo(h).once("value",function(b){var c=b.val();a.word=c[Object.keys(c)],console.log(a.word);var f=a.word.expression.split("");a.kanjis=[],a.results=[];for(var g=0;g<f.length;g++)f[g].match(/^[\u4e00-\u9faf]+$/)&&a.kanjis.push(f[g]);a.searchCharacter=function(b){var c=e.getAllKanjis();c.then(function(c){if(a.kanjis.length>=1)for(var d=0;d<a.kanjis.length;d++){var e=c.data.filter(function(a){return a.literal[0]==b[d]});if(e){var f=[];f=e[0],console.log(f),a.results.push(f)}}})},a.chinese=function(a){return"ja_on"==a.$.r_type},a.japanese=function(a){return"ja_kun"==a.$.r_type},0==!a.kanjis.length?a.searchCharacter(a.kanjis):console.log("No kanjis here."),d(function(){a.loading=!1},0)})}]),app.controller("WordSubmitCtrl",["$scope","addWord",function(a,b){a.form={},a.tags=[],a.onSubmit=function(){a.form.sentences||(a.form.sentences="No example sentences given."),a.form.reading||(a.form.reading="");var c={expression:a.form.expression,reading:a.form.reading,meaning:a.form.meaning,tags:a.form.selectedItem,sentences:a.form.sentences},d=Math.floor(Date.now()),e={activity:a.form.expression+" added to the wordbank",timestamp:d},f=a.form.selectedItem;console.log(f),b.submitWord(c,e,f),a.form=null},a.clearFields=function(){a.form=null};var c=firebase.auth().currentUser;if(c){var d=firebase.database().ref("users").child(c.uid+"/tagbank");d.on("value",function(b){a.tags=b.val(),console.log(a.tags)}),a.selectedItem=a.tags[0]}else console.log("not logged in")}]),app.directive("activity",function(){return{restrict:"E",scope:{recent:"="},templateUrl:"templates/mainviews/partials/frontpage-activity.html"}}),app.directive("addToDeck",function(){return{link:function(a,b){a.$watch("deckEnable",function(){b.on("click",function(b){function c(a,b){var c=a.indexOf(b);c===-1?(a.push(b),console.log(a)):(a.splice(c,1),console.log(a))}a.deckEnable&&(b.preventDefault(),b.stopImmediatePropagation(),b.stopPropagation(),c(a.collection,a.word.data),a.$apply(function(){a.selectedWord=!a.selectedWord}))}),a.deckEnable||(a.selectedWord=!1,a.collection.length=0)})}}}),app.directive("assignment",function(){return{restrict:"E",replace:!0,scope:{data:"="},controller:"AssignmentsCtrl",templateUrl:"templates/mainviews/partials/assignment-test.html"}}),app.directive("outsideClick",["$document","$parse",function(a,b){return{restrict:"A",link:function(b,c,d,e){c.bind("click",function(a){a.stopPropagation()}),a.bind("click",function(){b.$apply(d.outsideClick)})}}}]),app.directive("word",function(){return{restrict:"E",scope:{word:"="},templateUrl:"templates/mainviews/partials/wordbank-wordblock.html"}});